# 自动化用户故事开发循环

## 任务概述

执行完整的自动化用户故事开发循环，从故事创建到QA验收的端到端自动化流程。确保每个环节都有严格的质量控制和验证标准。

## 前置条件检查

- [ ] 数据库设计文档已完成 (`docs/database/database-design.md`)
- [ ] 基础代码已生成 (`src/main/java/`)
- [ ] Epic分解已完成 (`docs/epics/`)
- [ ] 测试环境已准备就绪
- [ ] 所有智能体处于可用状态

## 执行流程

### 阶段1: 用户故事创建 (SM智能体)

#### 1.1 切换到SM智能体

```bash
*agent sm
```

#### 1.2 创建增强用户故事

```bash
*draft-enhanced
```

#### 1.3 创建后质量检查

**必须验证的内容**:

- [ ] 用户故事格式符合模板要求
- [ ] 包含完整的数据库设计相关信息
- [ ] API接口规范详细完整
- [ ] 请求响应示例具体明确
- [ ] 数据映射关系准确
- [ ] 验收标准清晰可测试
- [ ] 任务分解合理可执行

#### 1.4 质量门控检查

如果任何检查项不通过：

- 记录问题详情
- 重新执行故事创建（最多3次）
- 超过重试次数则升级到项目经理

### 阶段2: 故事验证 (PO智能体)

#### 2.1 切换到PO智能体

```bash
*agent po
```

#### 2.2 执行故事验证

```bash
*validate-story-draft {story_file}
```

#### 2.3 验证检查清单

**业务需求验证**:

- [ ] 故事与PRD需求一致
- [ ] 业务价值明确
- [ ] 用户角色定义准确
- [ ] 功能边界清晰

**技术实现验证**:

- [ ] 数据库实体设计合理
- [ ] API接口设计符合规范
- [ ] 技术实现方案可行
- [ ] 性能要求现实

**可测试性验证**:

- [ ] 验收标准可验证
- [ ] 测试数据准备充分
- [ ] 测试场景覆盖完整
- [ ] 错误处理考虑周全

#### 2.4 验证结果处理

**如果验证通过**:

- 更新故事状态: `Draft → Approved`
- 记录验证通过时间
- 进入下一阶段

**如果验证失败**:

- 记录具体问题和修复建议
- 返回SM智能体修复故事
- 重复验证流程（最多3轮）

### 阶段3: 代码开发 (Dev智能体)

#### 3.1 切换到Dev智能体

```bash
*agent dev
```

#### 3.2 执行故事开发

```bash
*develop-story
```

#### 3.3 开发实现步骤

**数据库层实现**:

- [ ] 实现Mapper接口方法
- [ ] 编写SQL映射文件
- [ ] 添加数据验证逻辑
- [ ] 处理数据库约束

**业务逻辑层实现**:

- [ ] 实现Service接口
- [ ] 编写业务逻辑代码
- [ ] 添加业务规则验证
- [ ] 实现事务处理

**API接口层实现**:

- [ ] 实现Controller方法
- [ ] 添加请求参数验证
- [ ] 实现响应格式化
- [ ] 添加异常处理

**测试代码编写**:

- [ ] 编写单元测试
- [ ] 编写集成测试
- [ ] 编写API测试
- [ ] 编写数据库测试

#### 3.4 执行自测

```bash
*run-tests
```

#### 3.5 自测验证标准

**代码质量检查**:

- [ ] 所有单元测试通过 (100%)
- [ ] 代码覆盖率 ≥ 80%
- [ ] 静态代码分析通过
- [ ] 代码规范检查通过

**功能验证检查**:

- [ ] 所有API端点正常工作
- [ ] 数据库操作正确执行
- [ ] 业务逻辑符合需求
- [ ] 错误处理机制有效

**性能检查**:

- [ ] API响应时间 < 500ms
- [ ] 数据库查询优化
- [ ] 内存使用合理
- [ ] 并发处理正常

#### 3.6 自测结果处理

**如果自测通过**:

- 更新故事状态: `Approved → Review`
- 提交代码变更
- 更新文件列表
- 进入QA测试阶段

**如果自测失败**:

- 分析失败原因
- 修复代码问题
- 重新运行测试
- 重复直到通过（最多5轮）

### 阶段4: QA测试验证 (QA智能体)

#### 4.1 切换到QA智能体

```bash
*agent qa
```

#### 4.2 执行QA测试

```bash
*review {story_file}
```

#### 4.3 QA测试检查清单

**功能测试**:

- [ ] 所有验收标准得到满足
- [ ] 正常业务流程测试通过
- [ ] 边界条件处理正确
- [ ] 异常场景处理适当

**API契约测试**:

- [ ] 请求参数验证正确
- [ ] 响应格式符合规范
- [ ] HTTP状态码准确
- [ ] 错误响应格式正确

**数据完整性测试**:

- [ ] 数据创建操作正确
- [ ] 数据更新操作安全
- [ ] 数据删除遵循软删除
- [ ] 数据关联关系维护

**性能测试**:

- [ ] 响应时间满足要求
- [ ] 并发处理能力充分
- [ ] 内存使用效率高
- [ ] 数据库查询优化

**安全测试**:

- [ ] 输入验证充分
- [ ] SQL注入防护
- [ ] XSS攻击防护
- [ ] 权限控制有效

#### 4.4 QA结果处理

**如果QA测试通过**:

- 更新故事状态: `Review → Done`
- 记录测试通过时间
- 生成QA测试报告
- 当前故事开发完成

**如果QA测试失败**:

- 详细记录问题清单
- 评估问题严重程度
- 分配问题给Dev智能体
- 更新故事状态: `Review → InProgress`
- 返回开发阶段修复

### 阶段5: 循环控制和完成检查

#### 5.1 检查项目完成状态

```bash
*agent automation-orchestrator
*check-completion-status
```

#### 5.2 完成状态评估

**检查所有故事状态**:

- [ ] 统计各状态故事数量
- [ ] 识别阻塞和问题故事
- [ ] 计算整体完成进度
- [ ] 评估剩余工作量

#### 5.3 决策分支

**如果还有未完成故事**:

- 启动下一个故事的开发循环
- 重复阶段1-4的流程
- 持续监控进度和质量

**如果所有故事都已完成**:

- 生成项目完成报告
- 统计开发质量指标
- 归档所有文档和代码
- 标记项目开发阶段完成

## 质量控制机制

### 自动化验证

- 每个阶段都有明确的通过标准
- 自动化测试和检查工具
- 质量门控严格执行
- 问题自动识别和报告

### 错误处理策略

- 分类错误类型和严重程度
- 差异化的重试和修复策略
- 升级机制处理复杂问题
- 问题追踪和解决记录

### 进度监控

- 实时跟踪每个故事的状态
- 收集开发效率指标
- 识别瓶颈和改进机会
- 生成进度和质量报告

## 输出文件

### 故事文件

- `docs/stories/{epic}.{story}.{title}.md` - 用户故事文档
- `docs/stories/status-tracking.md` - 状态跟踪文档

### 实现文件

- `src/main/java/{package}/entity/` - 实体类
- `src/main/java/{package}/mapper/` - Mapper接口
- `src/main/java/{package}/service/` - 服务层
- `src/main/java/{package}/controller/` - 控制层
- `src/test/java/{package}/` - 测试代码

### 报告文件

- `docs/reports/development-progress.md` - 开发进度报告
- `docs/reports/quality-metrics.md` - 质量指标报告
- `docs/reports/completion-summary.md` - 完成总结报告

## 成功标准

### 个人故事成功标准

- 故事状态达到 `Done`
- 所有验收标准满足
- 代码质量达标
- 测试覆盖充分

### 整体项目成功标准

- 所有故事开发完成
- 质量指标达到要求
- 没有未解决的阻塞问题
- 文档和代码完整

## 故障恢复

### 智能体故障

- 自动重试机制
- 备用智能体切换
- 状态恢复和继续

### 系统故障

- 保存中间状态
- 支持断点续传
- 数据一致性保护

### 人工介入

- 提供人工接管接口
- 支持手动状态修正
- 保留自动化日志
