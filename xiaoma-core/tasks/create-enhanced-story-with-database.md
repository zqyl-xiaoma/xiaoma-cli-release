# 创建增强用户故事（包含数据库和API设计）

## 任务概述

基于Epic分解，结合数据库设计和API接口规范，创建详细的用户故事文档。此任务要求深度集成database-architect生成的数据库设计和API接口设计。

## 前置条件

- 已完成Epic分解和优先级排序
- 已有数据库设计文档 (`docs/database/database-design.md`)
- 已有API接口设计文档
- 已完成架构设计

## 输入要求

- Epic文档
- 数据库设计文档
- API接口设计文档
- 架构设计文档

## 执行步骤

### 1. 分析Epic和设计文档

#### 1.1 Epic分析

- 确定用户故事的业务价值和优先级
- 识别涉及的用户角色
- 明确功能边界和范围

#### 1.2 数据库设计分析

- 从`docs/database/database-design.md`中识别相关实体
- 确定涉及的数据表和字段
- 分析数据操作类型（增删改查）
- 理解业务规则和约束

#### 1.3 API接口分析

- 从API设计文档中识别相关接口
- 确定HTTP方法和路径
- 分析请求参数和响应格式
- 理解错误处理机制

### 2. 使用增强模板创建用户故事

使用模板：`enhanced-story-with-database-tmpl.yaml`

#### 2.1 基础信息填写

```yaml
epic_num: '{{epic_number}}'
story_num: '{{story_number}}'
story_title_short: '{{story_title}}'
role: '{{user_role}}'
action: '{{user_action}}'
benefit: '{{user_benefit}}'
```

#### 2.2 数据库设计部分填写

**相关实体表格**：

```markdown
| 实体名称 | 表名     | 主要用途     | 关键字段                     |
| -------- | -------- | ------------ | ---------------------------- |
| User     | users    | 用户信息管理 | id, username, email          |
| Product  | products | 产品信息管理 | id, name, price, category_id |
```

**数据操作清单**：

- 查询操作：明确需要的查询条件和返回字段
- 插入操作：明确需要插入的数据和验证规则
- 更新操作：明确可更新的字段和业务规则
- 删除操作：明确删除条件和级联规则

**业务规则约束**：

- 数据验证规则（长度、格式、范围）
- 外键约束和引用完整性
- 唯一性约束
- 业务逻辑约束（状态转换等）

#### 2.3 API接口规范部分填写

**API端点列表**：

```markdown
| 序号 | 接口名称     | HTTP方法 | 路径            | 说明               | 状态   |
| ---- | ------------ | -------- | --------------- | ------------------ | ------ |
| 1    | 创建用户     | POST     | /api/users      | 创建新用户账户     | 待实现 |
| 2    | 查询用户详情 | GET      | /api/users/{id} | 根据ID查询用户信息 | 待实现 |
```

**API详细设计**：
为每个API提供：

- 完整的请求参数说明
- 响应数据结构定义
- 具体的请求示例（curl命令）
- 成功和错误响应示例
- 错误码定义和处理建议

**数据映射关系**：

```markdown
#### 请求参数 -> 数据库字段映射

| API参数  | 数据库表 | 数据库字段 | 数据类型     | 说明     |
| -------- | -------- | ---------- | ------------ | -------- |
| username | users    | username   | VARCHAR(50)  | 用户名   |
| email    | users    | email      | VARCHAR(100) | 邮箱地址 |
```

#### 2.4 任务分解

**后端开发任务**：

- 数据库相关：Mapper方法实现、Service业务逻辑、数据验证
- API接口实现：Controller方法、参数验证、响应格式化、异常处理
- 测试相关：单元测试、集成测试、数据库测试

**前端开发任务**（如需要）：

- 页面组件实现
- API调用集成
- 表单验证
- 用户交互

#### 2.5 开发者说明

**数据库上下文**：

- 实体类位置：`src/main/java/{package}/entity/`
- Mapper接口位置：`src/main/java/{package}/mapper/`
- Service层位置：`src/main/java/{package}/service/`
- 业务逻辑要求和数据验证规则

**API接口上下文**：

- Controller位置：`src/main/java/{package}/controller/`
- 请求响应格式标准
- 错误处理机制
- 接口版本控制

**集成上下文**：

- 与其他模块的依赖关系
- 外部系统调用要求
- 缓存策略和事务处理
- 性能要求

### 3. 质量检查清单

#### 3.1 完整性检查

- [ ] 所有涉及的数据库实体都已识别
- [ ] 所有需要的API接口都已定义
- [ ] 请求参数和响应格式完整
- [ ] 错误处理机制明确
- [ ] 数据映射关系清晰

#### 3.2 一致性检查

- [ ] API参数与数据库字段对应
- [ ] 数据类型一致
- [ ] 业务规则与数据库约束匹配
- [ ] 接口设计符合RESTful规范

#### 3.3 可实现性检查

- [ ] 任务分解合理可执行
- [ ] 技术实现方案可行
- [ ] 测试覆盖充分
- [ ] 开发者说明详细

### 4. 输出文件

生成的用户故事文件：`docs/stories/{{epic_num}}.{{story_num}}.{{story_title_short}}.md`

### 5. 后续协作

#### 5.1 与开发者协作

- 确保开发者理解数据库设计和API规范
- 提供必要的技术支持和澄清
- 跟踪开发进度和问题解决

#### 5.2 与QA协作

- 明确测试重点和验收标准
- 提供API测试用例和数据
- 确保质量标准得到执行

## 模板使用示例

### 示例：用户注册功能

**用户故事**：

> 作为新用户，我希望能够注册账户，以便使用系统的各项功能。

**相关实体**：

- Users表：存储用户基本信息
- UserProfiles表：存储用户详细资料

**涉及API**：

- POST /api/users：创建用户账户
- POST /api/users/verify-email：验证邮箱
- GET /api/users/check-username：检查用户名可用性

**数据操作**：

- 插入用户基本信息到users表
- 验证用户名和邮箱的唯一性
- 创建用户会话信息

**API详细设计**：

```json
// POST /api/users
{
  "username": "johndoe",
  "email": "john@example.com",
  "password": "hashedPassword"
}

// 响应
{
  "code": 200,
  "message": "用户创建成功",
  "data": {
    "userId": 12345,
    "username": "johndoe",
    "email": "john@example.com",
    "status": "active"
  }
}
```

## 注意事项

1. **数据一致性**：确保API设计与数据库设计保持一致
2. **安全性**：考虑数据验证、权限控制和敏感信息保护
3. **性能**：关注查询效率和接口响应时间
4. **可维护性**：保持代码结构清晰和文档完整
5. **可测试性**：确保功能可以被充分测试
