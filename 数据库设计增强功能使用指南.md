# XIAOMA-CLI™ 数据库设计增强功能使用指南

## 概述

本次二次开发为XIAOMA-CLI™框架增加了强大的数据库设计和代码生成功能，通过集成MySQL MCP服务，实现了从需求分析到数据库设计，再到代码自动生成的完整流程。

## 新增功能特性

### 1. 数据库架构师智能体 (database-architect)

- **角色**: 专业数据库架构师和数据建模专家
- **图标**: 🗄️
- **专长**: MySQL架构设计、数据建模、性能优化、代码生成

### 2. 核心能力

#### 2.1 现有数据库分析

- 通过MCP mysql-server服务连接数据库
- 自动读取表结构、字段、索引、外键
- 生成数据库关系图（ER图）
- 创建或更新数据库文档

#### 2.2 数据库设计

- 基于PRD需求文档设计数据库
- 实体识别和属性定义
- 关系设计和约束定义
- 性能优化和索引策略

#### 2.3 代码自动生成

- DDL脚本（建表语句）
- DML脚本（数据操作语句）
- Java实体类（POJO）
- MyBatis Mapper接口和XML
- Service层代码
- Controller层RESTful API

## 使用流程

### 前置准备

1. **配置MCP MySQL服务**
   确保在Claude Desktop或IDE中配置了mysql-server MCP服务：

   ```json
   {
     "mcpServers": {
       "mysql-server": {
         "command": "npx",
         "args": ["@claudeai/mcp-server-mysql"],
         "env": {
           "MYSQL_HOST": "101.126.130.208",
           "MYSQL_PORT": "3306",
           "MYSQL_USER": "root",
           "MYSQL_PASSWORD": "root",
           "MYSQL_DATABASE": "api_db"
         }
       }
     }
   }
   ```

2. **项目结构准备**
   ```
   your-project/
   ├── docs/
   │   ├── database/     # 数据库文档目录
   │   ├── prd.md        # 产品需求文档
   │   └── architecture.md
   ├── src/
   │   └── main/
   │       └── java/
   └── xiaoma-core/      # XIAOMA-CLI核心文件
   ```

### 工作流使用步骤

#### 步骤1: 启动增强工作流

在Web UI或IDE中：

```
*workflow enhanced-fullstack-with-database
```

#### 步骤2: 需求分析阶段

1. **分析师创建项目简介**

   ```
   *agent analyst
   *create-project-brief
   ```

2. **PM创建PRD文档**
   ```
   *agent pm
   *create-prd
   ```

#### 步骤3: 数据库设计阶段

1. **分析现有数据库**（如果是现有项目项目）

   ```
   *agent database-architect
   *analyze-database
   ```

   系统会自动：
   - 连接到MySQL数据库
   - 读取所有表结构
   - 生成关系图
   - 创建`{project_name}-database.md`文档

2. **创建数据库设计**

   ```
   *create-database-design
   ```

   基于PRD需求，设计：
   - 实体和属性
   - 表关系
   - 索引策略
   - 性能优化方案

3. **生成DDL/DML脚本**

   ```
   *generate-ddl
   ```

   生成可执行的SQL脚本：

   ```sql
   CREATE TABLE `users` (
     `id` BIGINT NOT NULL AUTO_INCREMENT,
     `username` VARCHAR(50) NOT NULL,
     `email` VARCHAR(100) NOT NULL,
     `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
     PRIMARY KEY (`id`),
     UNIQUE INDEX `uk_email` (`email`)
   );
   ```

4. **生成Java代码**

   ```
   *generate-entities
   *generate-mappers
   ```

   自动生成：
   - Entity类（带Lombok注解）
   - DTO类
   - MyBatis Mapper接口和XML
   - Service接口和实现
   - Controller RESTful API

#### 步骤4: 架构设计阶段

架构师整合数据库设计：

```
*agent architect
*create-full-stack-architecture
```

#### 步骤5: 开发实现阶段

开发者使用生成的代码：

```
*agent dev
*develop-story
```

开发者可以直接使用生成的：

- 实体类
- Mapper接口
- 基础CRUD操作
- RESTful API框架

只需专注于业务逻辑实现。

## 数据库架构师命令详解

### 核心命令

| 命令                      | 功能       | 说明               |
| ------------------------- | ---------- | ------------------ |
| `*analyze-database`       | 分析数据库 | 连接MySQL读取结构  |
| `*create-database-design` | 创建设计   | 基于需求设计数据库 |
| `*generate-ddl`           | 生成DDL    | 创建建表语句       |
| `*generate-dml`           | 生成DML    | 创建数据操作语句   |
| `*generate-entities`      | 生成实体类 | 创建Java POJO      |
| `*generate-mappers`       | 生成Mapper | 创建MyBatis代码    |
| `*create-api-design`      | API设计    | 设计RESTful接口    |
| `*optimize-schema`        | 优化架构   | 性能优化建议       |

### 使用示例

#### 示例1: 分析现有数据库

```bash
# 激活数据库架构师
*agent database-architect

# 分析数据库
*analyze-database

# 系统输出
正在连接到MySQL数据库...
已发现15个表
正在分析表结构...
正在生成关系图...
文档已保存到: docs/database/myproject-database.md
```

#### 示例2: 从需求生成数据库设计

```bash
# 基于PRD创建数据库设计
*create-database-design

# 系统会：
1. 分析PRD中的业务需求
2. 识别核心实体（用户、产品、订单等）
3. 设计表结构和字段
4. 定义关系和约束
5. 生成完整设计文档
```

#### 示例3: 生成完整代码结构

```bash
# 生成所有代码
*generate-entities
*generate-mappers

# 生成的文件结构：
src/main/java/com/example/
├── entity/
│   ├── User.java
│   └── Product.java
├── dto/
│   ├── UserDTO.java
│   └── ProductDTO.java
├── mapper/
│   ├── UserMapper.java
│   └── ProductMapper.java
├── service/
│   ├── UserService.java
│   └── ProductService.java
└── controller/
    ├── UserController.java
    └── ProductController.java

src/main/resources/mapper/
├── UserMapper.xml
└── ProductMapper.xml
```

## 生成代码示例

### Entity类示例

```java
@Data
@TableName("users")
public class User {
    @TableId(type = IdType.AUTO)
    private Long id;

    private String username;
    private String email;

    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime createdAt;

    @TableField(fill = FieldFill.INSERT_UPDATE)
    private LocalDateTime updatedAt;
}
```

### Mapper XML示例

```xml
<mapper namespace="com.example.mapper.UserMapper">
    <select id="selectByQuery" resultMap="BaseResultMap">
        SELECT * FROM users
        WHERE deleted_at IS NULL
        <if test="query.username != null">
            AND username = #{query.username}
        </if>
    </select>
</mapper>
```

### Controller示例

```java
@RestController
@RequestMapping("/api/users")
public class UserController {
    @GetMapping("/{id}")
    public Result<UserDTO> getDetail(@PathVariable Long id) {
        return Result.success(userService.getDetail(id));
    }

    @PostMapping
    public Result<Boolean> create(@RequestBody UserDTO dto) {
        return Result.success(userService.create(dto));
    }
}
```

## 最佳实践

### 1. 数据库设计原则

- 遵循三范式设计
- 合理使用索引
- 考虑查询性能
- 预留扩展字段

### 2. 命名规范

- 表名：小写下划线分隔 (user_roles)
- 字段名：小写下划线分隔 (created_at)
- Java类：大驼峰 (UserRole)
- 变量名：小驼峰 (createdAt)

### 3. 安全考虑

- 使用软删除
- 实现乐观锁
- 敏感数据加密
- 参数化查询

### 4. 性能优化

- 合理的索引策略
- 避免N+1查询
- 使用缓存
- 分页查询

## 故障排除

### 问题1: 无法连接数据库

**解决方案**:

- 检查MCP mysql-server配置
- 验证数据库连接信息
- 确保数据库服务运行中

### 问题2: 生成的代码不符合项目规范

**解决方案**:

- 在生成前明确指定包名和规范
- 使用自定义模板
- 生成后进行代码审查和调整

### 问题3: 表关系识别不准确

**解决方案**:

- 手动在设计文档中调整关系
- 确保外键约束正确设置
- 使用明确的命名规范

## 扩展和自定义

### 自定义代码模板

可以修改生成模板以适应项目需求：

```yaml
# xiaoma-core/templates/entity-class-tmpl.yaml
custom_entity_template:
  annotations:
    - '@Entity'
    - '@Table(name = "{table_name}")'
  fields:
    id_generation: 'UUID'
    audit_fields: true
```

### 集成其他ORM框架

除了MyBatis，还可以生成：

- JPA/Hibernate实体
- Spring Data Repository
- QueryDSL查询类

## 总结

通过集成数据库设计功能，XIAOMA-CLI™现在提供了完整的从需求到代码的自动化流程：

1. **需求分析** → 2. **数据库设计** → 3. **代码生成** → 4. **业务实现**

这大大提高了开发效率，减少了重复性工作，让开发者能够专注于业务逻辑的实现。

## 版本信息

- 版本：1.0.0
- 更新日期：2024
- 作者：Database Architect Enhancement Team
