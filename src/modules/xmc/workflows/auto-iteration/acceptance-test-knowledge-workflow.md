# 验收测试知识库生成工作流

> **工作流 ID**: acceptance-test-knowledge
> **触发命令**: `*acceptance-test-knowledge`
> **智能体**: Phoenix (全自动化迭代开发编排器)
> **说明**: 从需求文档和用户故事中生成 AI 验收测试所需的操作步骤知识库(page_knowledge)和功能路径知识库(bill_path)

---

## 工作流概述

本工作流从原始需求文档和开发过程中的用户故事文档中，自动生成标准化的验收测试知识库，供 AI 智能测试部门进行最终的验收测试。

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      验收测试知识库生成流程                               │
├─────────────────────────────────────────────────────────────────────────┤
│  输入                                                                    │
│  ├─ 原始需求文档 (PRD / 迭代需求)                                        │
│  ├─ 用户故事文档 (sprint-artifacts/stories/*.md)                        │
│  └─ 页面截图 (可选，用于精确识别 UI 控件)                                 │
├─────────────────────────────────────────────────────────────────────────┤
│  Phase 1: 需求与故事分析                                                 │
│  ├─ 解析原始需求文档，提取功能模块信息                                     │
│  ├─ 解析用户故事文档，提取接受标准和操作流程                               │
│  └─ 识别业务线、平台类型（前台/后台/中台）                                 │
├─────────────────────────────────────────────────────────────────────────┤
│  Phase 2: 生成功能路径知识库 (bill_path)                                  │
│  ├─ 提取菜单导航路径                                                     │
│  ├─ 确定平台标识、业务操作、登录角色                                       │
│  └─ 生成 bill_path 表格                                                  │
├─────────────────────────────────────────────────────────────────────────┤
│  Phase 3: 生成操作步骤知识库 (page_knowledge)                             │
│  ├─ 按页面分解功能测试点                                                  │
│  ├─ 根据 UI 控件规范生成操作步骤                                          │
│  ├─ 确保 module 与 bill_path.path_module 匹配                            │
│  └─ 生成 page_knowledge 表格                                             │
├─────────────────────────────────────────────────────────────────────────┤
│  Phase 4: 输出验证与交付                                                  │
│  ├─ 验证两个知识库的关联关系                                              │
│  ├─ 输出 markdown 格式的知识库文件                                        │
│  └─ 生成知识库交付报告                                                    │
├─────────────────────────────────────────────────────────────────────────┤
│  输出                                                                    │
│  ├─ page_knowledge.md (操作步骤知识库)                                   │
│  ├─ bill_path.md (功能路径知识库)                                        │
│  └─ acceptance-test-knowledge-report.md (交付报告)                       │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 知识库关联关系

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       知识库关联关系                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  bill_path (功能路径知识库)                                              │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ path_module  ─────────────────┐                                 │   │
│  │ plat_type                      │                                 │   │
│  │ business_operations            │                                 │   │
│  │ option_des                     │   关联                          │   │
│  │ path                           │                                 │   │
│  │ login_role                     │                                 │   │
│  │ business                       │                                 │   │
│  │ login_address                  │                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                   │                                     │
│                                   ▼                                     │
│  page_knowledge (操作步骤知识库)                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ module  ◄─────────────────────┘                                 │   │
│  │ page                                                            │   │
│  │ page_cases                                                      │   │
│  │ steps                                                           │   │
│  │ sy_type                                                         │   │
│  │ business                                                        │   │
│  │ interface_value                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  关联规则: bill_path.path_module = page_knowledge.module                │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 执行指令

当用户输入 `*acceptance-test-knowledge` 时，按以下流程执行：

### Step 0: 初始化与输入收集

```yaml
initialization:
  required_inputs:
    - name: "原始需求文档"
      description: "PRD 或迭代需求文档路径"
      example: "docs/prd.md"

    - name: "用户故事目录"
      description: "用户故事文件所在目录"
      example: "sprint-artifacts/stories/"

    - name: "页面截图目录 (可选)"
      description: "UI 页面截图，用于精确识别控件"
      example: "docs/screenshots/"

  business_info:
    - name: "业务线"
      options: ["供应链票据", "中建二局", "中台-运营中心"]

    - name: "平台类型"
      options: ["前台", "后台", "中台"]
```

**执行动作**:
```
## 初始化验收测试知识库生成

### 请提供以下信息：

1. **原始需求文档路径**:
   - 请提供 PRD 或迭代需求文档的路径

2. **用户故事目录路径**:
   - 请提供 sprint-artifacts/stories/ 目录路径

3. **业务线** (选择一个):
   - [ ] 供应链票据
   - [ ] 中建二局
   - [ ] 中台-运营中心

4. **页面截图目录 (可选)**:
   - 如有 UI 截图，可提供路径以精确识别控件
```

---

### Step 1: 需求与故事分析 (Phase 1)

```yaml
phase: 1
name: 需求与故事分析
tasks:
  - name: 解析原始需求文档
    actions:
      - 提取功能模块列表
      - 识别业务线归属
      - 提取菜单路径信息
      - 识别平台类型（前台/后台/中台）

  - name: 解析用户故事文档
    actions:
      - 遍历 stories/ 目录下所有故事文件
      - 提取每个故事的接受标准 (Acceptance Criteria)
      - 提取操作流程和用户交互步骤
      - 识别涉及的页面和功能点

  - name: 构建功能-页面映射
    output:
      - 功能模块 → 页面列表
      - 页面 → 功能测试点列表
      - 页面 → UI 控件列表
```

---

### Step 2: 生成功能路径知识库 (Phase 2)

```yaml
phase: 2
name: 生成功能路径知识库 (bill_path)

field_definitions:
  plat_type:
    description: "平台标识"
    required: false
    rules:
      - 枚举值: ["前台", "后台", "中台"]
      - 如果属于中建二局，则赋值为空

  business_operations:
    description: "业务操作"
    required: true
    rules:
      - 后台: 等于菜单名称，如"有限追索"、"机构信息查询"
      - 前台: 根据具体业务操作命名，如"单笔出票"、"批量出票"

  option_des:
    description: "业务模块"
    required: true
    rules:
      - 后台: 等于二级菜单名称
      - 前台: 根据业务命名，如"出票业务"

  path:
    description: "操作路径"
    required: true
    rules:
      - 后台: 配置到菜单路径，如"有限追索"
      - 前台: 配置到二级页签，如"出票业务一级菜单/出票业务二级菜单/出票>经办页签"

  login_role:
    description: "登录角色"
    required: false
    rules:
      - 后台: 空
      - 前台: 配置操作该业务的角色，如"出票企业"、"收票企业"

  path_module:
    description: "当前模块"
    required: true
    rules:
      - 后台/中台/中建二局: 配置到菜单路径
      - 前台: 配置二级页签名称，需与 page_knowledge.module 匹配
    important: "此字段是与 page_knowledge 关联的关键字段！"

  business:
    description: "业务线"
    required: true
    options: ["供应链票据", "中建二局", "中台-运营中心"]

  login_address:
    description: "登录地址"
    required: true
    rules:
      前台_票据: "http://bill.${env}.yljr.com/zqyl-pjs/pjsHome"
      后台: "http://manager-${env}.cnyunlian.com:8081/zqyl_manager/center.htm"
      中建二局: "http://zqyl-zhongjian.test.com/zqyl-fc-dashboard/publicService/dashboard"
      中台_运营中心: "http://mps-${env}.yljr.com/zqyl-mps-operation/coreCompanyResPool/list"

output_format: |
  ## 功能路径知识库 (bill_path)

  | plat_type | business_operations | option_des | path | login_role | path_module | business | login_address |
  |-----------|---------------------|------------|------|------------|-------------|----------|---------------|
  | {值} | {值} | {值} | {值} | {值} | {值} | {值} | {值} |
```

**录入原则**:
1. 后台、中建二局、中台一个菜单配置一条
2. 前台一个子页面配置一条
3. `path_module` 必须与 `page_knowledge.module` 能成功匹配

---

### Step 3: 生成操作步骤知识库 (Phase 3)

```yaml
phase: 3
name: 生成操作步骤知识库 (page_knowledge)

field_definitions:
  module:
    description: "业务模块"
    required: true
    rules:
      - 后台/中台/中建二局: 配置到当前页签，即菜单名称
      - 前台: 配置二级页签名称，需与 bill_path.path_module 匹配
    important: "此字段是与 bill_path 关联的关键字段！"

  page:
    description: "页面名称"
    required: true
    rules:
      - 如果模块下只有一个页面，page = module
      - 如果模块下有多个页面，根据实际页面命名

  page_cases:
    description: "页面测试点"
    required: true
    rules:
      - 页面有哪些功能，就需要包含哪些测试点
      - 列表界面: "列表查询&列表重置"
      - 启用/禁用: "启用{菜单名称}"、"禁用{菜单名称}"
      - 新增/编辑/查看: "新增{菜单名称}"、"编辑{菜单名称}"、"查看{菜单名称}"
      - 特殊场景: 如涉及票据类型等，需区分，如"单笔出票-银票-平安银行"

  steps:
    description: "页面操作步骤"
    required: true
    rules: "详见下方【操作步骤生成规则】"

  sy_type:
    description: "系统前后台标识"
    required: false
    options: ["前台", "后台", "中台"]

  business:
    description: "业务线"
    required: true
    options: ["供应链票据", "中建二局", "中台-运营中心"]

  interface_value:
    description: "自动化参数匹配"
    required: false
    default: "nan"

output_format: |
  ## 操作步骤知识库 (page_knowledge)

  | module | page | page_cases | steps | sy_type | business | interface_value |
  |--------|------|------------|-------|---------|----------|-----------------|
  | {值} | {值} | {值} | {值} | {值} | {值} | nan |
```

---

### 操作步骤生成规则 (steps 字段)

#### 基本原则

```yaml
basic_principles:
  - 按照从上到下、从左到右的顺序识别页面控件
  - 操作步骤按序号编排，每个步骤以分号【;】结束
  - 关键元素用【】标记：模块名称、字段名称、输入/操作值
  - 操作步骤字段名称要与页面字段名称完全一致
```

#### UI 控件描述规范

```yaml
control_descriptions:
  文本框:
    format: "在【{字段名}】字段文本框中输入【${前置参数：{字段名}}】"
    example: "在【企业名称】字段文本框中输入【${前置参数：企业名称}】"

  按钮:
    format: "点击【{按钮名}】按钮"
    example: "点击【查询】按钮"

  单选按钮:
    format: "{字段名}字段单选选择【${枚举值1/枚举值2}】"
    example: "票据类型字段单选选择【${银票/商票}】"

  多选按钮:
    format: "{字段名}字段多选选择【${[]&枚举值1/枚举值2}】"
    example: "业务类型字段多选选择【${[]&出票/背书/贴现}】"

  下拉单选:
    format: "{字段名}字段下拉框选择【${枚举值1/枚举值2}】"
    example: "状态字段下拉框选择【${启用/禁用}】"

  下拉输入并选择:
    format: "{字段名}字段下拉框输入并选择【${前置参数：{字段名}}】"
    example: "融资方案名称字段下拉框输入并选择【${前置参数：融资方案名称}】"
    note: "此类控件基本都需要写成前置参数"

  是否单选:
    format: "{字段名}字段单选选择【${是/否}】"
    example: "是否允许分包流转字段单选选择【${是/否}】"

  文件上传:
    format: "点击【{按钮名}】按钮，【#fileNo:生成一个pdf的文件】"
    example: "点击【上传附件】按钮，【#fileNo:生成一个pdf的文件】"

  图片上传:
    format: "点击【{按钮名}】按钮，【#fileNo:生成一个JPG的图片】"
    example: "点击【上传照片】按钮，【#fileNo:生成一个JPG的图片】"

  金额输入:
    format: "{字段名}字段文本框中输入【${2000以内整数}】"
    example: "票面金额字段文本框中输入【${2000以内整数}】"

  日期控件:
    format: "{字段名}字段时间控件点击选择【YYYY-MM-DD】"
    example: "出票日期字段时间控件点击选择【YYYY-MM-DD】"

  备注字段:
    format: "备注字段文本框中输入【自动化测试】"

  禁止输入控件:
    format: "{字段名}字段输入框不需要用户输入"

  蓝色文字按钮:
    format: "{字段名}字段点击【{蓝色文字}】按钮可以查看{内容}"
    example: "营业执照照片字段点击【查看】按钮可以查看营业执照照片"

  表头时间字段:
    format_datetime: "表头【{字段名}】字段格式正常反显为【YYYY-MM-DD HH:mm:ss】"
    format_date: "表头【{字段名}】字段格式正常反显为【YYYY-MM-DD】"

  表头普通字段:
    format: "表头【{字段名}】字段正常反显为【${前置参数：{字段名}}】"
```

#### 常见功能 steps 模板

```yaml
function_templates:
  列表查询&列表重置:
    template: |
      1. 在【{查询字段1}】字段文本框中输入【${前置参数：{查询字段1}}】;
      2. 在【{查询字段2}】字段下拉框选择【${枚举值}】;
      ... (所有查询条件)
      N. 点击【查询】按钮;
      N+1. 点击【重置】按钮;
      N+2. 表头【{表头字段1}】字段正常反显为【${前置参数：{表头字段1}}】;
      ... (所有表头字段)

  新增功能:
    template: |
      1. 点击页面右上角的【新增】按钮;
      2. 在【{模块名}】模块，【必填字段】【{字段名}】字段文本框中输入【${字段名}】;
      ... (所有新增字段，必填字段加【必填字段】标记)
      N. 点击【保存】按钮;

  编辑功能:
    template: |
      1. 在【{查询字段}】字段文本框中输入【${前置参数：{查询字段}}】;
      2. 点击【查询】按钮;
      3. 选中查询结果中的第一条数据;
      4. 点击【编辑】按钮;
      5. {置灰字段名}字段正常反显为【${前置参数：{字段名}}】，只可查看，不可编辑;
      6. 在【{可编辑字段}】字段文本框中输入【${字段名}】;
      ... (可编辑字段，不需要标注【必填字段】)
      N. 点击【保存】按钮;

  查看功能:
    template: |
      1. 在【{查询字段}】字段文本框中输入【${前置参数：{查询字段}}】;
      2. 点击【查询】按钮;
      3. 选中查询结果中的第一条数据;
      4. 点击【查看】按钮;
      5. 在【{模块名}】模块中，{字段名}字段正常反显为【${前置参数：{字段名}}】;
      ... (所有展示字段，不包含表头字段)

  启用功能:
    template: |
      1. 在【{查询字段}】字段文本框中输入【${前置参数：{查询字段}}】;
      2. 点击【查询】按钮;
      3. 选中查询结果中的第一条数据;
      4. 点击【启用】按钮;
      5. 表头【状态】字段正常反显为【启用】;

  禁用功能:
    template: |
      1. 在【{查询字段}】字段文本框中输入【${前置参数：{查询字段}}】;
      2. 点击【查询】按钮;
      3. 选中查询结果中的第一条数据;
      4. 点击页面右上角的【禁用】按钮;
      5. 弹出提示弹框，点击【确定】;
      6. 弹出禁用原因弹框，文本框输入【随机生成的禁用原因】;
      7. 点击【确定】;
      8. 表头【状态】字段正常反显为【禁用】;

  导出功能:
    template: |
      1. 在【{查询字段}】字段文本框中输入【${前置参数：{查询字段}}】;
      ... (查询条件)
      N. 点击【查询】按钮;
      N+1. 点击【导出】按钮;
```

#### 特殊处理规则

```yaml
special_rules:
  前台_Ukey审核:
    有暂存按钮: "点击页面下方的【暂存】按钮，【Ukey审核：{业务场景}】"
    无暂存按钮: "【Ukey审核：{业务场景}】"

  模块分区:
    rule: "页面元素分多模块时，需在 steps 中加上模块描述"
    example: "在【分配授信信息】模块，操作列点击【添加信用方】字段出现添加信用方弹框"

  重复操作:
    rule: "添加多条数据时，使用【重复以下步骤添加多个】"
    example: "添加多个被代管企业【${前置参数：被代管企业}】，重复以下步骤添加多个"

  弹框操作:
    rule: "弹框中的按钮点击都写成单独步骤，按顺序排列"

  带括号字段:
    rule: "字段名保留括号，前置参数去掉括号"
    example: "表头【实缴合计（元）】字段正常反显为【${前置参数：实缴合计}】"
```

---

### Step 4: 输出验证与交付 (Phase 4)

```yaml
phase: 4
name: 输出验证与交付

validation:
  - name: 关联关系验证
    check: "bill_path.path_module = page_knowledge.module"
    action: "确保每个 page_knowledge.module 在 bill_path.path_module 中都有对应记录"

  - name: 必填字段验证
    check: "所有必填字段都已填充"

  - name: 格式验证
    check: "steps 中每个步骤以分号结束，关键元素用【】标记"

outputs:
  - file: "page_knowledge.md"
    description: "操作步骤知识库"
    format: "markdown 表格"

  - file: "bill_path.md"
    description: "功能路径知识库"
    format: "markdown 表格"

  - file: "acceptance-test-knowledge-report.md"
    description: "交付报告"
    content:
      - 生成统计（模块数、页面数、测试点数）
      - 关联关系验证结果
      - 交付清单
```

---

## 输出示例

### bill_path.md (功能路径知识库)

```markdown
## 功能路径知识库 (bill_path)

| plat_type | business_operations | option_des | path | login_role | path_module | business | login_address |
|-----------|---------------------|------------|------|------------|-------------|----------|---------------|
| 前台 | 单笔出票 | 出票业务 | 出票业务一级菜单/出票业务二级菜单/出票>经办页签 | 出票企业 | 出票>经办 | 供应链票据 | http://bill.${env}.yljr.com/zqyl-pjs/pjsHome |
| 前台 | 出票审核 | 出票业务 | 出票业务一级菜单/出票业务二级菜单/出票>审核页签 | 出票企业 | 出票>审核 | 供应链票据 | http://bill.${env}.yljr.com/zqyl-pjs/pjsHome |
| 后台 | 机构信息查询 | 基础信息查询 | 机构信息查询 | nan | 机构信息查询 | 供应链票据 | http://manager-${env}.cnyunlian.com:8081/zqyl_manager/center.htm |
| 后台 | 有限追索 | 白名单管理 | 有限追索 | nan | 有限追索 | 供应链票据 | http://manager-${env}.cnyunlian.com:8081/zqyl_manager/center.htm |
```

### page_knowledge.md (操作步骤知识库)

```markdown
## 操作步骤知识库 (page_knowledge)

| module | page | page_cases | steps | sy_type | business | interface_value |
|--------|------|------------|-------|---------|----------|-----------------|
| 机构信息查询 | 机构信息查询 | 列表查询&列表重置 | 1. 在【机构名称】字段文本框中输入【${前置参数：机构名称}】;2. 在【机构代码】字段文本框中输入【${前置参数：机构代码}】;3. 点击【查询】按钮;4. 点击【重置】按钮;5. 表头【机构名称】字段正常反显为【${前置参数：机构名称}】;6. 表头【机构代码】字段正常反显为【${前置参数：机构代码}】;7. 表头【创建时间】字段格式正常反显为【YYYY-MM-DD HH:mm:ss】; | 后台 | 供应链票据 | nan |
| 有限追索 | 白名单查询 | 列表查询&列表重置 | 1. 在【企业名称】字段文本框中输入【${前置参数：企业名称}】;2. 点击【查询】按钮;3. 点击【重置】按钮;4. 表头【企业名称】字段正常反显为【${前置参数：企业名称}】; | 后台 | 供应链票据 | nan |
| 有限追索 | 白名单查询 | 新增白名单查询 | 1. 点击页面右上角的【新增】按钮;2. 【必填字段】【企业名称】字段下拉框输入并选择【${前置参数：企业名称}】;3. 【必填字段】【生效日期】字段时间控件点击选择【YYYY-MM-DD】;4. 备注字段文本框中输入【自动化测试】;5. 点击【保存】按钮; | 后台 | 供应链票据 | nan |
| 出票>经办 | 出票经办 | 单笔出票-银票 | 1. 点击【单笔出票】按钮;2. 在【基本信息】模块，【必填字段】票据种类字段单选选择【银票】;3. 【必填字段】【出票金额】字段文本框中输入【${2000以内整数}】;4. 【必填字段】【到期日】字段时间控件点击选择【YYYY-MM-DD】;5. 在【收票人信息】模块，【必填字段】【收票企业】字段下拉框输入并选择【${前置参数：收票企业}】;6. 点击页面下方的【暂存】按钮，【Ukey审核：出票经办审核】; | 前台 | 供应链票据 | nan |
```

---

## 执行检查清单

```yaml
checklist:
  phase_1:
    - [ ] 原始需求文档已解析
    - [ ] 用户故事文档已遍历
    - [ ] 功能模块列表已提取
    - [ ] 业务线已确定

  phase_2:
    - [ ] 所有菜单路径已收集
    - [ ] path_module 已正确设置
    - [ ] login_address 已根据平台类型配置
    - [ ] bill_path.md 已生成

  phase_3:
    - [ ] 所有页面已分解为测试点
    - [ ] module 与 bill_path.path_module 匹配
    - [ ] steps 按 UI 控件规范描述
    - [ ] 必填字段已标记
    - [ ] page_knowledge.md 已生成

  phase_4:
    - [ ] 关联关系已验证
    - [ ] 输出格式已验证
    - [ ] 交付报告已生成
```

---

## 与其他工作流的关系

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         工作流关系图                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  requirement-to-epic-workflow                                           │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 输出: PRD + Architecture + Epics                                │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│                              ▼                                          │
│  story-implementation-workflow                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 输出: 实现的代码 + 测试 + 用户故事文档                           │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│                              ▼                                          │
│  acceptance-test-knowledge-workflow  ◄── 本工作流                       │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 输入: PRD + 用户故事文档 + 页面截图(可选)                        │   │
│  │ 输出: page_knowledge.md + bill_path.md                          │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│                              ▼                                          │
│  AI 智能测试部门                                                        │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 使用知识库进行验收测试                                           │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```
