# 知识库调用点定义

> 本文档定义全自动迭代开发流程中所有需要访问知识库的调用点，包括具体的查询问题模板。

---

## 知识库接口规范

### 当前实现（前期模拟）
- **数据源**: `{project-root}/docs/rag/rag.md`
- **访问方式**: 直接读取文件，基于关键词匹配提取相关内容

### 未来实现（MCP 服务）
- **服务**: Knowledge Base MCP Server
- **调用方式**: `mcp__kb__query(question, context)`
- **返回格式**:
```yaml
response:
  answer: "知识库返回的答案"
  sources:
    - document: "来源文档"
      section: "章节"
      confidence: 0.95
  related_topics:
    - "相关主题1"
    - "相关主题2"
```

---

## Phase 1: 需求分析 - 知识库调用点

### KBC-1.1: 业务术语解释

**调用时机**: 解析需求文档时遇到业务术语

**问题模板**:
```
请解释以下业务术语的定义和使用场景：
- 术语: {term}
- 上下文: {context_sentence}

需要返回：
1. 术语的标准定义
2. 在当前业务系统中的具体含义
3. 相关的业务规则
4. 使用示例
```

**决策依赖**:
- 如果知识库有定义 → 使用知识库定义
- 如果知识库无定义 → 标记为"新术语"，使用需求文档中的描述

---

### KBC-1.2: 业务规则验证

**调用时机**: 识别到功能需求时，验证是否存在相关业务规则

**问题模板**:
```
请查询与以下功能相关的业务规则：
- 功能描述: {feature_description}
- 涉及实体: {entities}
- 业务场景: {scenario}

需要返回：
1. 适用的业务规则列表
2. 每条规则的具体内容
3. 规则之间的优先级关系
4. 规则的例外情况
```

**决策依赖**:
- 匹配到规则 → 功能实现必须遵守这些规则
- 未匹配到规则 → 记录为"需要新增业务规则"

---

### KBC-1.3: 业务流程查询

**调用时机**: 需求涉及业务流程时

**问题模板**:
```
请查询以下业务流程的详细步骤：
- 流程名称: {process_name}
- 触发条件: {trigger}
- 参与角色: {roles}

需要返回：
1. 完整的流程步骤
2. 每个步骤的前置条件
3. 每个步骤的输出
4. 异常处理流程
5. 相关的审批规则
```

**决策依赖**:
- 流程已定义 → 实现必须符合流程定义
- 流程未定义 → 根据需求创建新流程定义

---

### KBC-1.4: 约束条件查询

**调用时机**: 分析需求约束时

**问题模板**:
```
请查询与以下内容相关的业务约束和限制：
- 业务领域: {domain}
- 操作类型: {operation_type}
- 数据类型: {data_type}

需要返回：
1. 数据验证规则（格式、范围、必填等）
2. 业务限制（次数、金额、时间等）
3. 权限要求
4. 合规要求
```

**决策依赖**:
- 存在约束 → 实现中必须加入对应校验
- 无约束 → 使用通用最佳实践

---

## Phase 2: 需求规划 - 知识库调用点

### KBC-2.1: 用户角色定义

**调用时机**: 创建用户故事时需要明确用户角色

**问题模板**:
```
请查询以下用户角色的详细定义：
- 角色名称: {role_name}
- 所属系统: {system}

需要返回：
1. 角色的职责描述
2. 角色的权限范围
3. 角色与其他角色的关系
4. 角色的典型使用场景
```

**决策依赖**:
- 角色已定义 → 使用知识库中的角色定义
- 角色未定义 → 创建新角色定义

---

### KBC-2.2: 验收标准参考

**调用时机**: 定义功能需求的验收标准时

**问题模板**:
```
请查询类似功能的验收标准参考：
- 功能类型: {feature_type}（如：列表查询、表单提交、文件上传等）
- 业务领域: {domain}

需要返回：
1. 标准的验收标准模板
2. 必须覆盖的测试场景
3. 边界条件示例
4. 性能要求
```

**决策依赖**:
- 有参考模板 → 基于模板定制验收标准
- 无参考模板 → 使用通用 Given-When-Then 格式

---

### KBC-2.3: NFR 标准查询

**调用时机**: 定义非功能需求时

**问题模板**:
```
请查询以下类型的非功能需求标准：
- NFR 类型: {nfr_type}（性能/安全/可用性/可维护性）
- 系统级别: {system_level}（核心/普通/边缘）
- 用户规模: {user_scale}

需要返回：
1. 具体的指标要求
2. 测量方法
3. 达标阈值
4. 优化建议
```

**决策依赖**:
- 有标准定义 → 使用知识库中的标准
- 无标准定义 → 使用行业通用标准

---

### KBC-2.4: 优先级规则查询

**调用时机**: 确定功能优先级时

**问题模板**:
```
请查询功能优先级的评估规则：
- 功能影响: {impact}（用户数、业务收入等）
- 功能复杂度: {complexity}
- 依赖情况: {dependencies}

需要返回：
1. 优先级评估矩阵
2. P0/P1/P2 的定义标准
3. 优先级调整规则
```

**决策依赖**:
- 有评估规则 → 按规则计算优先级
- 无评估规则 → 基于业务价值和技术依赖评估

---

## Phase 3: 架构设计 - 知识库调用点

### KBC-3.1: 技术栈规范查询

**调用时机**: 确认技术选型时

**问题模板**:
```
请查询项目的技术栈规范：
- 层级: {layer}（前端/后端/数据库/中间件）
- 功能类型: {feature_type}

需要返回：
1. 推荐的技术框架/库
2. 版本要求
3. 禁止使用的技术
4. 技术选型的理由
```

**决策依赖**:
- 有规范 → 必须使用规范中的技术
- 无规范 → 基于现有代码库推断

---

### KBC-3.2: 架构模式查询

**调用时机**: 设计系统架构时

**问题模板**:
```
请查询推荐的架构模式：
- 功能类型: {feature_type}
- 系统特点: {system_characteristics}
- 扩展性要求: {scalability_requirements}

需要返回：
1. 推荐的架构模式
2. 模式的实现指南
3. 代码示例
4. 注意事项
```

**决策依赖**:
- 有推荐模式 → 使用推荐的架构模式
- 无推荐模式 → 基于最佳实践选择

---

### KBC-3.3: 数据模型规范查询

**调用时机**: 设计数据库表结构时

**问题模板**:
```
请查询数据模型设计规范：
- 实体类型: {entity_type}
- 数据库类型: {database_type}

需要返回：
1. 命名规范（表名、字段名）
2. 字段类型规范
3. 索引设计规范
4. 必备字段（如 created_at, updated_at）
5. 软删除/硬删除规范
```

**决策依赖**:
- 有规范 → 严格遵循规范设计
- 无规范 → 使用通用最佳实践

---

### KBC-3.4: API 设计规范查询

**调用时机**: 设计 API 接口时

**问题模板**:
```
请查询 API 设计规范：
- API 类型: {api_type}（RESTful/GraphQL/RPC）
- 接口功能: {functionality}

需要返回：
1. URL 命名规范
2. HTTP 方法使用规范
3. 请求/响应格式规范
4. 错误码规范
5. 分页规范
6. 认证授权规范
```

**决策依赖**:
- 有规范 → 严格遵循规范设计
- 无规范 → 使用 RESTful 最佳实践

---

### KBC-3.5: 安全规范查询

**调用时机**: 设计涉及安全的功能时

**问题模板**:
```
请查询安全设计规范：
- 安全场景: {security_scenario}（认证/授权/数据加密/输入验证）
- 数据敏感度: {sensitivity_level}

需要返回：
1. 安全要求清单
2. 实现指南
3. 禁止的做法
4. 安全测试要求
```

**决策依赖**:
- 有安全规范 → 必须满足所有安全要求
- 无安全规范 → 使用 OWASP 标准

---

## Phase 4: 开发实现 - 知识库调用点

### KBC-4.1: 编码规范查询

**调用时机**: 编写代码前

**问题模板**:
```
请查询编码规范：
- 编程语言: {language}
- 代码类型: {code_type}（组件/服务/工具类/测试）

需要返回：
1. 命名规范
2. 代码格式规范
3. 注释规范
4. 文件组织规范
5. 导入顺序规范
```

**决策依赖**:
- 有规范 → 代码必须符合规范
- 无规范 → 遵循语言社区最佳实践

---

### KBC-4.2: 错误处理规范查询

**调用时机**: 实现错误处理逻辑时

**问题模板**:
```
请查询错误处理规范：
- 错误类型: {error_type}（业务错误/系统错误/外部错误）
- 处理层级: {layer}（Controller/Service/Repository）

需要返回：
1. 错误码定义规范
2. 错误消息格式
3. 日志记录要求
4. 异常传播规则
5. 用户提示规范
```

**决策依赖**:
- 有规范 → 按规范处理错误
- 无规范 → 使用通用错误处理模式

---

### KBC-4.3: 测试规范查询

**调用时机**: 编写测试代码时

**问题模板**:
```
请查询测试规范：
- 测试类型: {test_type}（单元测试/集成测试/E2E测试）
- 被测代码类型: {code_type}

需要返回：
1. 测试文件命名规范
2. 测试用例命名规范
3. Mock/Stub 使用规范
4. 断言规范
5. 覆盖率要求
6. 测试数据管理规范
```

**决策依赖**:
- 有规范 → 测试代码必须符合规范
- 无规范 → 使用 AAA 模式（Arrange-Act-Assert）

---

### KBC-4.4: 业务逻辑实现查询

**调用时机**: 实现具体业务逻辑时遇到不明确的业务规则

**问题模板**:
```
请查询以下业务场景的实现规则：
- 业务场景: {scenario}
- 输入条件: {input_conditions}
- 期望行为: {expected_behavior}

需要返回：
1. 详细的业务规则
2. 边界条件处理
3. 异常情况处理
4. 示例数据
```

**决策依赖**:
- 有明确规则 → 按规则实现
- 无明确规则 → 标记为"需确认"，使用保守实现

---

### KBC-4.5: 代码审查规则查询

**调用时机**: 执行代码审查时

**问题模板**:
```
请查询代码审查检查清单：
- 代码类型: {code_type}
- 审查级别: {review_level}（快速/标准/严格）

需要返回：
1. 必须检查的项目
2. 常见问题清单
3. 安全检查项
4. 性能检查项
5. 可维护性检查项
```

**决策依赖**:
- 有审查规则 → 按规则审查
- 无审查规则 → 使用通用代码审查清单

---

## Phase 5: 测试验证 - 知识库调用点

### KBC-5.1: 测试覆盖率要求查询

**调用时机**: 验证测试覆盖率时

**问题模板**:
```
请查询测试覆盖率要求：
- 项目级别: {project_level}
- 代码模块: {module_type}

需要返回：
1. 语句覆盖率要求
2. 分支覆盖率要求
3. 函数覆盖率要求
4. 豁免规则
```

**决策依赖**:
- 有明确要求 → 必须达到要求
- 无明确要求 → 使用默认阈值 80%

---

### KBC-5.2: 质量门禁标准查询

**调用时机**: 执行质量门禁检查时

**问题模板**:
```
请查询质量门禁标准：
- 检查类型: {check_type}
- 发布阶段: {release_stage}（开发/测试/生产）

需要返回：
1. 必须通过的检查项
2. 每项的阈值
3. 可豁免的情况
4. 失败处理流程
```

**决策依赖**:
- 有标准 → 按标准执行门禁
- 无标准 → 使用默认质量门禁

---

### KBC-5.3: 性能基准查询

**调用时机**: 执行性能测试时

**问题模板**:
```
请查询性能基准：
- 接口类型: {api_type}
- 业务场景: {scenario}
- 并发级别: {concurrency_level}

需要返回：
1. 响应时间基准
2. 吞吐量基准
3. 资源使用基准
4. 降级阈值
```

**决策依赖**:
- 有基准 → 性能必须达到基准
- 无基准 → 使用行业通用标准

---

## 知识库调用汇总表

| 阶段 | 调用点 ID | 调用时机 | 知识类型 |
|-----|----------|---------|---------|
| Phase 1 | KBC-1.1 | 遇到业务术语 | 业务 |
| Phase 1 | KBC-1.2 | 识别功能需求 | 业务 |
| Phase 1 | KBC-1.3 | 涉及业务流程 | 业务 |
| Phase 1 | KBC-1.4 | 分析约束条件 | 业务 |
| Phase 2 | KBC-2.1 | 创建用户故事 | 业务 |
| Phase 2 | KBC-2.2 | 定义验收标准 | 业务+技术 |
| Phase 2 | KBC-2.3 | 定义 NFR | 技术 |
| Phase 2 | KBC-2.4 | 确定优先级 | 业务 |
| Phase 3 | KBC-3.1 | 技术选型 | 技术 |
| Phase 3 | KBC-3.2 | 架构设计 | 技术 |
| Phase 3 | KBC-3.3 | 数据模型设计 | 技术 |
| Phase 3 | KBC-3.4 | API 设计 | 技术 |
| Phase 3 | KBC-3.5 | 安全设计 | 技术 |
| Phase 4 | KBC-4.1 | 编写代码 | 技术 |
| Phase 4 | KBC-4.2 | 错误处理 | 技术 |
| Phase 4 | KBC-4.3 | 编写测试 | 技术 |
| Phase 4 | KBC-4.4 | 实现业务逻辑 | 业务 |
| Phase 4 | KBC-4.5 | 代码审查 | 技术 |
| Phase 5 | KBC-5.1 | 覆盖率验证 | 技术 |
| Phase 5 | KBC-5.2 | 质量门禁 | 技术 |
| Phase 5 | KBC-5.3 | 性能测试 | 技术 |

---

## 知识库调用流程

```
┌─────────────────────────────────────────────────────────────┐
│                    知识库调用流程                            │
├─────────────────────────────────────────────────────────────┤
│  1. 识别调用点                                               │
│     └─ 根据当前任务匹配调用点 ID                              │
├─────────────────────────────────────────────────────────────┤
│  2. 构建查询                                                 │
│     └─ 使用问题模板填充上下文参数                             │
├─────────────────────────────────────────────────────────────┤
│  3. 执行查询                                                 │
│     ├─ 前期: 从 docs/rag/rag.md 检索                        │
│     └─ 后期: 调用 MCP 知识库服务                             │
├─────────────────────────────────────────────────────────────┤
│  4. 解析结果                                                 │
│     ├─ 匹配成功: 提取答案和来源                              │
│     └─ 未匹配: 标记为"未找到"                                │
├─────────────────────────────────────────────────────────────┤
│  5. 决策执行                                                 │
│     ├─ 有知识: 基于知识库内容决策                            │
│     └─ 无知识: 使用默认策略 + 标记待确认                      │
├─────────────────────────────────────────────────────────────┤
│  6. 记录日志                                                 │
│     └─ 记录查询内容、结果、决策                              │
└─────────────────────────────────────────────────────────────┘
```
