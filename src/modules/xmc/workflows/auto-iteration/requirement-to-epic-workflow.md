# 需求分析到 Epic 生成工作流

> **工作流 ID**: requirement-to-epic
> **触发命令**: `*requirement-to-epic`
> **智能体**: Phoenix (全自动化迭代开发编排器)
> **说明**: 本工作流是 `full-auto-workflow` 的前半部分，专注于从需求文档到 Epic/架构设计的自动化转换

---

## 工作流概述

本工作流实现从需求文档到 Epic 和架构设计的自动化生成，融合 Analyst、PM、Architect 三大智能体能力，通过知识库驱动所有决策。

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       需求分析到 Epic 生成流程                             │
├─────────────────────────────────────────────────────────────────────────┤
│  输入                                                                    │
│  ├─ 迭代需求文档（产品经理提供）                                          │
│  ├─ 业务知识库（业务规则、领域知识）                                       │
│  └─ 技术知识库（技术规范、代码规范、架构模式）                              │
├─────────────────────────────────────────────────────────────────────────┤
│  Phase 1: 需求分析 [Analyst 能力]                                        │
│  ├─ 唤醒命令: /analyst                                                  │
│  ├─ 执行命令: *product-brief, *research (可选)                          │
│  ├─ 解析需求文档，匹配业务知识库规则                                       │
│  ├─ 识别隐含需求和约束                                                   │
│  └─ 输出: requirement-analysis.md / product-brief.md                   │
├─────────────────────────────────────────────────────────────────────────┤
│  Phase 2: 需求规划 [PM 能力]                                             │
│  ├─ 唤醒命令: /pm                                                       │
│  ├─ 执行命令: *create-prd, *validate-prd (推荐)                         │
│  ├─ 创建 PRD 文档，定义功能需求和非功能需求                                 │
│  └─ 输出: prd.md                                                        │
├─────────────────────────────────────────────────────────────────────────┤
│  Phase 3: 架构设计 [Architect 能力]                                      │
│  ├─ 唤醒命令: /architect                                                │
│  ├─ 执行命令: *create-architecture, *validate-architecture (推荐)       │
│  ├─ 分析现有代码架构，设计技术方案                                         │
│  └─ 输出: architecture.md + adr/                                        │
├─────────────────────────────────────────────────────────────────────────┤
│  Phase 2.5: 创建史诗和故事定义 [PM 能力] (依赖架构设计)                     │
│  ├─ 唤醒命令: /pm                                                       │
│  ├─ 执行命令: *create-epics-and-stories                                 │
│  ├─ 基于 PRD + 架构创建 Epic 文件（包含故事定义）                           │
│  └─ 输出: epics/epic-XXX.md                                             │
├─────────────────────────────────────────────────────────────────────────┤
│  输出                                                                    │
│  ├─ requirement-analysis.md (需求分析报告)                               │
│  ├─ prd.md (产品需求文档)                                                │
│  ├─ architecture.md (架构设计文档)                                       │
│  ├─ adr/ (架构决策记录)                                                  │
│  └─ epics/epic-XXX.md (史诗和故事定义)                                   │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 智能体命令汇总表

| 阶段 | 智能体 | 唤醒命令 | 核心工作流命令 | 用途 |
|------|--------|---------|---------------|------|
| Phase 1 | Mary (Analyst) | `/analyst` | `*product-brief`, `*research` | 需求分析、业务规则匹配 |
| Phase 2 | John (PM) | `/pm` | `*create-prd`, `*validate-prd` | PRD 创建、验证 |
| Phase 3 | Winston (Architect) | `/architect` | `*create-architecture`, `*validate-architecture` | 架构设计、技术决策 |
| Phase 2.5 | John (PM) | `/pm` | `*create-epics-and-stories` | 史诗和故事定义 |

---

## 执行指令

当用户输入 `*requirement-to-epic` 时，按以下流程自动执行：

### Step 0: 初始化

```yaml
initialization:
  checks:
    - 迭代需求文档路径或内容
    - 目标项目路径

  knowledge_base:
    mode: "rag"
    file_path: "{project-root}/docs/rag/rag.md"

  outputs:
    - auto-iteration-status.yaml (记录执行状态)
```

---

### Step 1: 需求分析阶段 (Phase 1)

**角色激活**: Analyst (Mary)

```
┌─────────────────────────────────────────────────────────────────┐
│  Phase 1: 需求分析                                               │
│  智能体: Mary (Analyst)                                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Step 1.1: 唤醒 Analyst 智能体                                   │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ 执行命令: /analyst                                          ││
│  │ 说明: 唤醒业务分析师 Mary，准备进行需求分析工作                ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  Step 1.2: 执行产品简报工作流                                    │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ 执行命令: *product-brief                                    ││
│  │ 说明: 基于迭代需求文档，创建结构化的产品简报                   ││
│  │ 输入: 迭代需求文档内容                                        ││
│  │ 输出: product-brief.md                                      ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  Step 1.3: (可选) 执行深度调研                                   │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ 执行命令: *research                                         ││
│  │ 说明: 针对复杂需求进行市场/竞品/技术调研                      ││
│  │ 触发条件: 需求涉及新业务领域或技术栈                          ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**执行命令**:
```bash
# 1. 唤醒 Analyst 智能体
/analyst

# 2. 执行产品简报工作流
*product-brief

# 3. (可选) 执行深度调研
*research
```

**质量门禁**:
- [ ] 所有功能点都已识别
- [ ] 业务规则匹配率 > 80%
- [ ] 无未解决的业务冲突

---

### Step 2: 需求规划阶段 (Phase 2)

**角色激活**: PM (John)

```
┌─────────────────────────────────────────────────────────────────┐
│  Phase 2: 需求规划                                               │
│  智能体: John (PM)                                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Step 2.1: 唤醒 PM 智能体                                        │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ 执行命令: /pm                                               ││
│  │ 说明: 唤醒产品经理 John，准备进行需求规划工作                  ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  Step 2.2: 创建 PRD 文档                                         │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ 执行命令: *create-prd                                       ││
│  │ 说明: 基于需求分析报告，创建完整的产品需求文档                 ││
│  │ 输入: requirement-analysis.md / product-brief.md            ││
│  │ 输出: prd.md                                                ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  Step 2.3: (推荐) 验证 PRD                                       │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ 执行命令: *validate-prd                                     ││
│  │ 说明: 使用全新上下文和不同 LLM 验证 PRD 质量                  ││
│  │ 建议: 使用不同的 LLM 以获得更客观的评估                       ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**执行命令**:
```bash
# 1. 唤醒 PM 智能体
/pm

# 2. 创建 PRD 文档
*create-prd

# 3. (推荐) 验证 PRD
*validate-prd
```

**质量门禁**:
- [ ] PRD 覆盖所有已识别的功能点
- [ ] 每个功能都有明确的用户故事格式
- [ ] 非功能需求定义完整

---

### Step 3: 架构设计阶段 (Phase 3)

**角色激活**: Architect (Winston)

```
┌─────────────────────────────────────────────────────────────────┐
│  Phase 3: 架构设计                                               │
│  智能体: Winston (Architect)                                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Step 3.1: 唤醒 Architect 智能体                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ 执行命令: /architect                                        ││
│  │ 说明: 唤醒架构师 Winston，准备进行架构设计工作                 ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  Step 3.2: 创建架构文档                                          │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ 执行命令: *create-architecture                              ││
│  │ 说明: 基于 PRD 创建完整的架构设计文档                         ││
│  │ 输入: prd.md + 现有代码库                                    ││
│  │ 输出: architecture.md + adr/                                ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  Step 3.3: (推荐) 验证架构                                       │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ 执行命令: *validate-architecture                            ││
│  │ 说明: 使用全新上下文和不同 LLM 验证架构设计                   ││
│  │ 建议: 使用不同的 LLM 以获得更客观的评估                       ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  Step 3.4: (可选) 创建架构图                                     │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ 执行命令: *create-excalidraw-diagram                        ││
│  │ 说明: 创建系统架构图或技术图表                                ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**执行命令**:
```bash
# 1. 唤醒 Architect 智能体
/architect

# 2. 创建架构文档
*create-architecture

# 3. (推荐) 验证架构
*validate-architecture

# 4. (可选) 创建架构图
*create-excalidraw-diagram
```

**质量门禁**:
- [ ] 架构设计覆盖所有功能需求
- [ ] 技术决策都有知识库依据
- [ ] 数据模型设计完整
- [ ] API 设计符合现有规范

---

### Step 4: 创建史诗和故事定义 (Phase 2.5)

**角色激活**: PM (John)

> **注意**: 此步骤在架构设计完成后执行，因为故事定义需要参考架构设计中的技术说明。

```
┌─────────────────────────────────────────────────────────────────┐
│  Phase 2.5: 创建史诗和故事定义                                    │
│  智能体: John (PM)                                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Step 4.1: 唤醒 PM 智能体                                        │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ 执行命令: /pm                                               ││
│  │ 说明: 唤醒产品经理 John，准备创建史诗和故事                   ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  Step 4.2: 创建史诗和故事定义                                    │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ 执行命令: *create-epics-and-stories                         ││
│  │ 说明: 从 PRD + 架构创建史诗和用户故事定义                    ││
│  │ 输入: prd.md + architecture.md                              ││
│  │ 输出: epics/epic-XXX.md                                     ││
│  │                                                              ││
│  │ ⚠️ 重要说明:                                                 ││
│  │ - 故事定义写在 Epic 文件中                                   ││
│  │ - 不创建独立的故事文件                                       ││
│  │ - 故事文件将在 story-implementation-workflow 中创建          ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**执行命令**:
```bash
# 1. 唤醒 PM 智能体
/pm

# 2. 创建史诗和故事定义
*create-epics-and-stories
```

**质量门禁**:
- [ ] 每个 Epic 包含完整的故事定义
- [ ] 每个故事有明确的接受标准 (Given-When-Then)
- [ ] 优先级排序完成
- [ ] 故事点估算完成 (可选)

---

## 输出物清单

工作流完成后，应产生以下文档：

```yaml
outputs:
  phase_1:
    - file: "requirement-analysis.md"
      description: "需求分析报告"
    - file: "product-brief.md"
      description: "产品简报 (来自 *product-brief)"

  phase_2:
    - file: "prd.md"
      description: "产品需求文档"

  phase_3:
    - file: "architecture.md"
      description: "架构设计文档"
    - folder: "adr/"
      description: "架构决策记录"

  phase_2_5:
    - folder: "epics/"
      description: "史诗文件（包含故事定义）"
      files:
        - "epic-001.md"
        - "epic-002.md"
        - "..."
```

---

## 后续步骤

本工作流完成后，可以执行以下操作：

1. **执行用户故事实现工作流** (推荐)
   ```bash
   *story-implementation
   ```
   将 Epic 中定义的故事逐个实现（创建→校验→开发→审查→测试）

2. **执行完整的全自动工作流** (如果需要从头开始)
   ```bash
   *auto-iterate
   ```
   执行完整的端到端自动化开发流程

---

## 与 full-auto-workflow 的关系

```
full-auto-workflow = requirement-to-epic-workflow + story-implementation-workflow + Sprint 收尾

                    ┌─────────────────────────────────────────┐
                    │        requirement-to-epic-workflow      │
                    │  (Phase 1 + Phase 2 + Phase 3 + Phase 2.5)│
                    │  ┌─────────────────────────────────────┐ │
                    │  │ /analyst → *product-brief          │ │
                    │  │ /pm → *create-prd                  │ │
                    │  │ /architect → *create-architecture  │ │
                    │  │ /pm → *create-epics-and-stories    │ │
                    │  └─────────────────────────────────────┘ │
                    │  输出: PRD + Architecture + Epics       │
                    └─────────────────────────────────────────┘
                                        │
                                        ▼
                    ┌─────────────────────────────────────────┐
                    │       story-implementation-workflow      │
                    │              (Phase 4)                   │
                    │  ┌─────────────────────────────────────┐ │
                    │  │ 对每个故事循环执行 5 步生命周期:     │ │
                    │  │ /sm → *create-story                │ │
                    │  │ /sm → *validate-create-story       │ │
                    │  │ /dev → *develop-story              │ │
                    │  │ /dev → *code-review                │ │
                    │  │ /tea → *trace + *test-review       │ │
                    │  └─────────────────────────────────────┘ │
                    │  输出: 实现的代码 + 测试 + 验证报告      │
                    └─────────────────────────────────────────┘
                                        │
                                        ▼
                    ┌─────────────────────────────────────────┐
                    │          Sprint 收尾 (可选)              │
                    │              (Phase 5)                   │
                    │  ┌─────────────────────────────────────┐ │
                    │  │ /tea → *nfr-assess (可选)           │ │
                    │  │ Sprint 最终报告                     │ │
                    │  └─────────────────────────────────────┘ │
                    └─────────────────────────────────────────┘
```

---

## 执行完成

当所有阶段完成后，输出完成报告：

```markdown
# 需求分析到 Epic 生成完成报告

## 执行摘要
- **开始时间**: {start_time}
- **完成时间**: {end_time}
- **状态**: ✅ 成功完成

## 产出物
- [x] requirement-analysis.md / product-brief.md
- [x] prd.md
- [x] architecture.md
- [x] epics/epic-XXX.md (N 个)

## 后续步骤
执行 `*story-implementation` 开始用户故事的自动化实现
```
